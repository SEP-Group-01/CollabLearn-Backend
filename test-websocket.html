<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Forum WebSocket Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .container {
        border: 1px solid #ccc;
        padding: 20px;
        margin: 10px 0;
        border-radius: 5px;
      }
      .messages {
        height: 300px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 10px;
        margin: 10px 0;
        background-color: #f9f9f9;
      }
      input,
      textarea,
      button {
        margin: 5px;
        padding: 8px;
      }
      input,
      textarea {
        width: 200px;
      }
      button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background-color: #0056b3;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
      .connected {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .disconnected {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
    </style>
  </head>
  <body>
    <h1>Forum WebSocket Test Client</h1>

    <div class="container">
      <h3>Connection Status</h3>
      <div id="status" class="status disconnected">Disconnected</div>
      <button onclick="connect()">Connect</button>
      <button onclick="disconnect()">Disconnect</button>
    </div>

    <div class="container">
      <h3>Join Group</h3>
      <input type="number" id="groupId" placeholder="Group ID" value="1" />
      <input type="text" id="userId" placeholder="User ID" value="user123" />
      <button onclick="joinGroup()">Join Group</button>
      <button onclick="leaveGroup()">Leave Group</button>
    </div>

    <div class="container">
      <h3>Send Message</h3>
      <textarea id="messageContent" placeholder="Message content"></textarea>
      <button onclick="sendMessage()">Send Message</button>
    </div>

    <div class="container">
      <h3>Additional Tests</h3>
      <button onclick="testTyping()">Test Typing Indicator</button>
      <button onclick="testReply()">Test Reply</button>
      <button onclick="testLike()">Test Like Message</button>
      <button onclick="testPinMessage()">Test Pin Message</button>
    </div>

    <div class="container">
      <h3>Messages</h3>
      <div id="messages" class="messages"></div>
      <button onclick="clearMessages()">Clear Messages</button>
    </div>

    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <script>
      let socket = null;
      let currentGroupId = null;
      let currentUserId = null;

      function addMessage(message, type = 'info') {
        const messagesDiv = document.getElementById('messages');
        const messageElement = document.createElement('div');
        messageElement.style.padding = '5px';
        messageElement.style.margin = '2px 0';
        messageElement.style.borderLeft = `3px solid ${type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#007bff'}`;
        messageElement.style.paddingLeft = '10px';
        messageElement.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      function updateStatus(connected) {
        const statusDiv = document.getElementById('status');
        if (connected) {
          statusDiv.textContent = 'Connected';
          statusDiv.className = 'status connected';
        } else {
          statusDiv.textContent = 'Disconnected';
          statusDiv.className = 'status disconnected';
        }
      }

      function connect() {
        if (socket && socket.connected) {
          addMessage('Already connected!', 'error');
          return;
        }

        socket = io('http://localhost:3003/forum', {
          cors: {
            origin: 'http://localhost:3000',
            credentials: true,
          },
        });

        socket.on('connect', () => {
          addMessage('Connected to WebSocket server!', 'success');
          updateStatus(true);
        });

        socket.on('disconnect', () => {
          addMessage('Disconnected from WebSocket server', 'error');
          updateStatus(false);
        });

        socket.on('user-joined', (data) => {
          addMessage(`User joined: ${JSON.stringify(data)}`, 'info');
        });

        socket.on('user-left', (data) => {
          addMessage(`User left: ${JSON.stringify(data)}`, 'info');
        });

        socket.on('new-message', (data) => {
          addMessage(`New message: ${JSON.stringify(data)}`, 'success');
        });

        socket.on('new-reply', (data) => {
          addMessage(`New reply: ${JSON.stringify(data)}`, 'success');
        });

        socket.on('like-updated', (data) => {
          addMessage(`Like updated: ${JSON.stringify(data)}`, 'info');
        });

        socket.on('user-typing', (data) => {
          addMessage(`User typing: ${JSON.stringify(data)}`, 'info');
        });

        socket.on('message-pin-updated', (data) => {
          addMessage(`Message pin updated: ${JSON.stringify(data)}`, 'info');
        });

        socket.on('notification', (data) => {
          addMessage(`Notification: ${JSON.stringify(data)}`, 'info');
        });

        socket.on('connect_error', (error) => {
          addMessage(`Connection error: ${error.message}`, 'error');
          updateStatus(false);
        });
      }

      function disconnect() {
        if (socket) {
          socket.disconnect();
          socket = null;
          updateStatus(false);
          addMessage('Disconnected manually', 'info');
        }
      }

      function joinGroup() {
        if (!socket || !socket.connected) {
          addMessage('Not connected to server!', 'error');
          return;
        }

        currentGroupId = parseInt(document.getElementById('groupId').value);
        currentUserId = document.getElementById('userId').value;

        if (!currentGroupId || !currentUserId) {
          addMessage('Please enter both Group ID and User ID', 'error');
          return;
        }

        socket.emit(
          'join-group',
          {
            groupId: currentGroupId,
            userId: currentUserId,
          },
          (response) => {
            addMessage(
              `Join group response: ${JSON.stringify(response)}`,
              'success',
            );
          },
        );
      }

      function leaveGroup() {
        if (!socket || !socket.connected) {
          addMessage('Not connected to server!', 'error');
          return;
        }

        if (!currentGroupId || !currentUserId) {
          addMessage('Not currently in a group', 'error');
          return;
        }

        socket.emit(
          'leave-group',
          {
            groupId: currentGroupId,
            userId: currentUserId,
          },
          (response) => {
            addMessage(
              `Leave group response: ${JSON.stringify(response)}`,
              'success',
            );
            currentGroupId = null;
            currentUserId = null;
          },
        );
      }

      function sendMessage() {
        if (!socket || !socket.connected) {
          addMessage('Not connected to server!', 'error');
          return;
        }

        if (!currentGroupId || !currentUserId) {
          addMessage('Please join a group first', 'error');
          return;
        }

        const content = document.getElementById('messageContent').value;
        if (!content.trim()) {
          addMessage('Please enter message content', 'error');
          return;
        }

        socket.emit(
          'send-message',
          {
            groupId: currentGroupId,
            userId: currentUserId,
            content: content,
          },
          (response) => {
            addMessage(
              `Send message response: ${JSON.stringify(response)}`,
              'success',
            );
            if (response.success) {
              document.getElementById('messageContent').value = '';
            }
          },
        );
      }

      function clearMessages() {
        document.getElementById('messages').innerHTML = '';
      }

      // Additional test functions
      function testTyping() {
        if (!socket || !socket.connected || !currentGroupId || !currentUserId) {
          addMessage('Please connect and join a group first', 'error');
          return;
        }

        addMessage('Sending typing indicator...', 'info');
        socket.emit('typing', {
          groupId: currentGroupId,
          userId: currentUserId,
          isTyping: true,
        });

        // Stop typing after 2 seconds
        setTimeout(() => {
          socket.emit('typing', {
            groupId: currentGroupId,
            userId: currentUserId,
            isTyping: false,
          });
        }, 2000);
      }

      function testReply() {
        if (!socket || !socket.connected || !currentGroupId || !currentUserId) {
          addMessage('Please connect and join a group first', 'error');
          return;
        }

        // First send a message, then reply to it
        socket.emit(
          'send-message',
          {
            groupId: currentGroupId,
            userId: currentUserId,
            content: 'Original message for reply test',
          },
          (response) => {
            if (response.success && response.message) {
              // Reply to the message
              socket.emit(
                'send-reply',
                {
                  messageId: response.message.id,
                  userId: currentUserId,
                  content: 'This is a reply to the message',
                  groupId: currentGroupId,
                },
                (replyResponse) => {
                  addMessage(
                    `Reply response: ${JSON.stringify(replyResponse)}`,
                    'success',
                  );
                },
              );
            }
          },
        );
      }

      function testLike() {
        if (!socket || !socket.connected || !currentGroupId || !currentUserId) {
          addMessage('Please connect and join a group first', 'error');
          return;
        }

        // First send a message, then like it
        socket.emit(
          'send-message',
          {
            groupId: currentGroupId,
            userId: currentUserId,
            content: 'Message to test likes',
          },
          (response) => {
            if (response.success && response.message) {
              // Like the message
              socket.emit(
                'toggle-like',
                {
                  messageId: response.message.id,
                  userId: currentUserId,
                  groupId: currentGroupId,
                  type: 'message',
                },
                (likeResponse) => {
                  addMessage(
                    `Like response: ${JSON.stringify(likeResponse)}`,
                    'success',
                  );
                },
              );
            }
          },
        );
      }

      function testPinMessage() {
        if (!socket || !socket.connected || !currentGroupId || !currentUserId) {
          addMessage('Please connect and join a group first', 'error');
          return;
        }

        // First send a message, then pin it
        socket.emit(
          'send-message',
          {
            groupId: currentGroupId,
            userId: currentUserId,
            content: 'Message to test pinning',
          },
          (response) => {
            if (response.success && response.message) {
              // Pin the message
              socket.emit(
                'pin-message',
                {
                  messageId: response.message.id,
                  userId: currentUserId,
                  groupId: currentGroupId,
                  action: 'pin',
                },
                (pinResponse) => {
                  addMessage(
                    `Pin response: ${JSON.stringify(pinResponse)}`,
                    'success',
                  );
                },
              );
            }
          },
        );
      }

      // Auto-connect on page load
      window.onload = function () {
        addMessage(
          'WebSocket test client loaded. Click Connect to start.',
          'info',
        );
      };
    </script>
  </body>
</html>
