<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quiz Service Frontend Integration Test</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }

      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
      }

      .test-section {
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #fafafa;
      }

      .test-section h3 {
        margin-top: 0;
        color: #2196f3;
      }

      .form-group {
        margin: 15px 0;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }

      input,
      textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
      }

      button {
        background: #2196f3;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
        font-size: 16px;
      }

      button:hover {
        background: #1976d2;
      }

      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .success {
        color: #4caf50;
        font-weight: bold;
      }

      .error {
        color: #f44336;
        font-weight: bold;
      }

      .log {
        background: #333;
        color: #fff;
        padding: 15px;
        border-radius: 4px;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
        margin-top: 10px;
      }

      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        font-weight: bold;
      }

      .status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .quiz-card {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
      }

      .quiz-card h4 {
        margin: 0 0 10px 0;
        color: #333;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üöÄ Quiz Service Frontend Integration Test</h1>

      <!-- Configuration Section -->
      <div class="test-section">
        <h3>‚öôÔ∏è Configuration</h3>
        <div class="form-group">
          <label>API Base URL:</label>
          <input type="text" id="apiUrl" value="http://localhost:3000" />
        </div>
        <div class="form-group">
          <label>Email:</label>
          <input
            type="email"
            id="email"
            value="test@example.com"
            placeholder="Enter your email"
          />
        </div>
        <div class="form-group">
          <label>Password:</label>
          <input
            type="password"
            id="password"
            value="password123"
            placeholder="Enter your password"
          />
        </div>
        <div class="form-group">
          <label>Thread ID:</label>
          <input
            type="text"
            id="threadId"
            value="550e8400-e29b-41d4-a716-446655440000"
            placeholder="Enter valid thread ID"
          />
        </div>
      </div>

      <!-- Authentication Section -->
      <div class="test-section">
        <h3>üîê Authentication Test</h3>
        <button onclick="testLogin()">Login & Get Token</button>
        <div id="authStatus"></div>
      </div>

      <!-- Health Check Section -->
      <div class="test-section">
        <h3>‚ù§Ô∏è Health Check Test</h3>
        <button onclick="testHealth()">Test Health Endpoint</button>
        <div id="healthStatus"></div>
      </div>

      <!-- Quiz Creation Section -->
      <div class="test-section">
        <h3>üìù Quiz Creation Test</h3>
        <div class="form-group">
          <label>Quiz Title:</label>
          <input
            type="text"
            id="quizTitle"
            value="Frontend Integration Test Quiz"
          />
        </div>
        <div class="form-group">
          <label>Quiz Description:</label>
          <textarea id="quizDescription" rows="3">
This quiz tests the frontend-backend integration for the quiz service.</textarea
          >
        </div>
        <div class="form-group">
          <label>Time Allocated (minutes):</label>
          <input type="number" id="timeAllocated" value="15" min="1" />
        </div>
        <button onclick="testCreateQuiz()" id="createQuizBtn" disabled>
          Create Quiz
        </button>
        <div id="createQuizStatus"></div>
      </div>

      <!-- Quiz Fetching Section -->
      <div class="test-section">
        <h3>üìã Quiz Fetching Test</h3>
        <button onclick="testGetQuizzes()" id="getQuizzesBtn" disabled>
          Get All Quizzes
        </button>
        <div id="getQuizzesStatus"></div>
        <div id="quizzesList"></div>
      </div>

      <!-- WebSocket Testing Section -->
      <div class="test-section">
        <h3>üîó WebSocket Test</h3>
        <button onclick="testWebSocket()" id="websocketBtn" disabled>
          Test WebSocket Connection
        </button>
        <div id="websocketStatus"></div>
      </div>

      <!-- Run All Tests -->
      <div class="test-section">
        <h3>üéØ Complete Integration Test</h3>
        <button onclick="runAllTests()">Run All Tests</button>
        <div id="allTestsStatus"></div>
      </div>

      <!-- Console Log -->
      <div class="test-section">
        <h3>üìÑ Console Output</h3>
        <button onclick="clearLog()">Clear Log</button>
        <div id="consoleLog" class="log"></div>
      </div>
    </div>

    <script>
      let authToken = '';
      const API_BASE_URL = () => document.getElementById('apiUrl').value;

      function log(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const logElement = document.getElementById('consoleLog');
        const prefix =
          type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
        logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`;
        logElement.scrollTop = logElement.scrollHeight;
        console.log(message);
      }

      function clearLog() {
        document.getElementById('consoleLog').textContent = '';
      }

      function showStatus(elementId, message, isSuccess = true) {
        const element = document.getElementById(elementId);
        element.innerHTML = `<div class="status ${isSuccess ? 'success' : 'error'}">${message}</div>`;
      }

      async function testLogin() {
        try {
          log('Starting login test...');
          const email = document.getElementById('email').value;
          const password = document.getElementById('password').value;

          const response = await fetch(`${API_BASE_URL()}/auth/login`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email, password }),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              `Login failed: ${response.status} - ${JSON.stringify(errorData)}`,
            );
          }

          const data = await response.json();
          authToken = data.token;

          log('Login successful! Token obtained.', 'success');
          showStatus(
            'authStatus',
            '‚úÖ Authentication successful! Token obtained.',
            true,
          );

          // Enable other buttons
          document.getElementById('createQuizBtn').disabled = false;
          document.getElementById('getQuizzesBtn').disabled = false;
          document.getElementById('websocketBtn').disabled = false;

          return data;
        } catch (error) {
          log(`Login failed: ${error.message}`, 'error');
          showStatus(
            'authStatus',
            `‚ùå Authentication failed: ${error.message}`,
            false,
          );
          throw error;
        }
      }

      async function testHealth() {
        try {
          log('Testing health endpoint...');
          const response = await fetch(`${API_BASE_URL()}/quizzes/health`);

          if (!response.ok) {
            throw new Error(`Health check failed: ${response.status}`);
          }

          const data = await response.json();
          log('Health check successful!', 'success');
          showStatus(
            'healthStatus',
            `‚úÖ Health check passed! Status: ${data.status}`,
            true,
          );
          return data;
        } catch (error) {
          log(`Health check failed: ${error.message}`, 'error');
          showStatus(
            'healthStatus',
            `‚ùå Health check failed: ${error.message}`,
            false,
          );
          throw error;
        }
      }

      async function testCreateQuiz() {
        try {
          if (!authToken) {
            throw new Error('Please login first');
          }

          log('Creating quiz...');
          const quizData = {
            title: document.getElementById('quizTitle').value,
            description: document.getElementById('quizDescription').value,
            timeAllocated: parseInt(
              document.getElementById('timeAllocated').value,
            ),
            thread_id: document.getElementById('threadId').value,
            questions: [
              {
                question_text:
                  'What is the primary purpose of this integration test?',
                marks: 10,
                options: [
                  {
                    text: 'To verify frontend-backend integration',
                    is_correct: true,
                  },
                  { text: 'To learn JavaScript', is_correct: false },
                  { text: 'To test database performance', is_correct: false },
                ],
              },
              {
                question_text: 'Which HTTP method is used for quiz creation?',
                marks: 5,
                options: [
                  { text: 'GET', is_correct: false },
                  { text: 'POST', is_correct: true },
                  { text: 'PUT', is_correct: false },
                ],
              },
            ],
            tags: ['integration', 'test'],
            resourceTags: ['frontend'],
          };

          const response = await fetch(`${API_BASE_URL()}/quizzes`, {
            method: 'POST',
            headers: {
              Authorization: `Bearer ${authToken}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(quizData),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              `Quiz creation failed: ${response.status} - ${JSON.stringify(errorData)}`,
            );
          }

          const data = await response.json();
          log('Quiz created successfully!', 'success');
          showStatus(
            'createQuizStatus',
            `‚úÖ Quiz created successfully! ID: ${data.quiz?.id || 'N/A'}`,
            true,
          );
          return data;
        } catch (error) {
          log(`Quiz creation failed: ${error.message}`, 'error');
          showStatus(
            'createQuizStatus',
            `‚ùå Quiz creation failed: ${error.message}`,
            false,
          );
          throw error;
        }
      }

      async function testGetQuizzes() {
        try {
          if (!authToken) {
            throw new Error('Please login first');
          }

          log('Fetching quizzes...');
          const response = await fetch(`${API_BASE_URL()}/quizzes`, {
            headers: {
              Authorization: `Bearer ${authToken}`,
            },
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              `Fetch quizzes failed: ${response.status} - ${JSON.stringify(errorData)}`,
            );
          }

          const data = await response.json();
          log(
            `Fetched ${data.quizzes?.length || 0} quizzes successfully!`,
            'success',
          );
          showStatus(
            'getQuizzesStatus',
            `‚úÖ Fetched ${data.quizzes?.length || 0} quizzes successfully!`,
            true,
          );

          // Display quizzes
          const quizzesListElement = document.getElementById('quizzesList');
          if (data.quizzes && data.quizzes.length > 0) {
            quizzesListElement.innerHTML =
              '<h4>üìã Available Quizzes:</h4>' +
              data.quizzes
                .map(
                  (quiz) => `
                            <div class="quiz-card">
                                <h4>${quiz.title}</h4>
                                <p><strong>ID:</strong> ${quiz.id}</p>
                                <p><strong>Description:</strong> ${quiz.description || 'No description'}</p>
                                <p><strong>Time Allocated:</strong> ${quiz.time_allocated} minutes</p>
                                <p><strong>Created:</strong> ${new Date(quiz.created_at).toLocaleString()}</p>
                            </div>
                        `,
                )
                .join('');
          } else {
            quizzesListElement.innerHTML = '<p>No quizzes found.</p>';
          }

          return data;
        } catch (error) {
          log(`Fetch quizzes failed: ${error.message}`, 'error');
          showStatus(
            'getQuizzesStatus',
            `‚ùå Fetch quizzes failed: ${error.message}`,
            false,
          );
          throw error;
        }
      }

      function testWebSocket() {
        return new Promise((resolve, reject) => {
          try {
            if (!authToken) {
              throw new Error('Please login first');
            }

            log('Testing WebSocket connection...');

            const socket = io(`${API_BASE_URL()}/quiz`, {
              auth: {
                token: `Bearer ${authToken}`,
              },
            });

            socket.on('connect', () => {
              log('WebSocket connected successfully!', 'success');
              showStatus(
                'websocketStatus',
                '‚úÖ WebSocket connection successful!',
                true,
              );
              socket.disconnect();
              resolve({ connected: true });
            });

            socket.on('connect_error', (error) => {
              log(`WebSocket connection failed: ${error.message}`, 'error');
              showStatus(
                'websocketStatus',
                `‚ùå WebSocket connection failed: ${error.message}`,
                false,
              );
              reject(error);
            });

            // Timeout after 5 seconds
            setTimeout(() => {
              socket.disconnect();
              const errorMsg = 'WebSocket connection timeout';
              log(errorMsg, 'error');
              showStatus('websocketStatus', `‚ùå ${errorMsg}`, false);
              reject(new Error(errorMsg));
            }, 5000);
          } catch (error) {
            log(`WebSocket test error: ${error.message}`, 'error');
            showStatus(
              'websocketStatus',
              `‚ùå WebSocket test error: ${error.message}`,
              false,
            );
            reject(error);
          }
        });
      }

      async function runAllTests() {
        log('üöÄ Starting complete integration test suite...', 'success');
        showStatus('allTestsStatus', 'üöÄ Running complete test suite...', true);

        let passedTests = 0;
        let totalTests = 5;

        try {
          // Test 1: Health
          log('\n1. Testing health endpoint...');
          await testHealth();
          passedTests++;

          // Test 2: Authentication
          log('\n2. Testing authentication...');
          await testLogin();
          passedTests++;

          // Test 3: Quiz creation
          log('\n3. Testing quiz creation...');
          await testCreateQuiz();
          passedTests++;

          // Test 4: Fetch quizzes
          log('\n4. Testing quiz fetching...');
          await testGetQuizzes();
          passedTests++;

          // Test 5: WebSocket
          log('\n5. Testing WebSocket connection...');
          await testWebSocket();
          passedTests++;

          log(
            `\nüéâ All tests completed successfully! (${passedTests}/${totalTests})`,
            'success',
          );
          showStatus(
            'allTestsStatus',
            `üéâ All tests passed! (${passedTests}/${totalTests}) Your quiz service is ready for frontend integration!`,
            true,
          );
        } catch (error) {
          log(`\nüí• Test suite failed: ${error.message}`, 'error');
          showStatus(
            'allTestsStatus',
            `üí• Test suite failed: ${error.message} (${passedTests}/${totalTests} tests passed)`,
            false,
          );

          log('\nüîß Troubleshooting steps:', 'info');
          log(
            '1. Verify all services are running (api-gateway, quiz-service, auth-service, workspaces-service)',
          );
          log('2. Check if Kafka is running on localhost:9092');
          log('3. Verify database connection and schema');
          log('4. Check if you have valid user credentials');
          log('5. Ensure thread_id exists and user has permissions');
        }
      }

      // Initialize
      log(
        'üîß Quiz Service Frontend Integration Test loaded. Configure settings and run tests above.',
      );
      log(
        'üí° Tip: Update the email, password, and thread_id fields with valid values before testing.',
      );
    </script>
  </body>
</html>
